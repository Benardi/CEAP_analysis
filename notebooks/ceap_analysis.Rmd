---
title: "C.E.A.P Analysis"
subtitle: "Exploratory data analysis on 'Quota for the exercise of parliamentary activity' provided by the Brazilian government"
author: "José Benardi de Souza Nunes"
date: 30/08/2018
output:
  html_notebook:
    toc: yes
    toc_float: yes
---

<br>

# Introduction 

<br>

> This exploratory data analysis was made based on data provided by the Brazilian government  about the expenses allowed to its parliamentarians or C.E.A.P. (Cota para o Exercício da Atividade Parlamentar / Quota for the Exercise of Parliamentary Activity). More information about it (in Portuguese) can be found in its [official site](http://www2.camara.leg.br/transparencia/acesso-a-informacao/copy_of_perguntas-frequentes/cota-para-o-exercicio-da-atividade-parlamentar)

<br>

```{r}
library(tidyverse)
library(lubridate)
library(here)
```

```{r}
data <- read_csv(here::here("data/dadosCEAP.csv"),
                 progress = F,
                 col_types = cols(
                   nomeParlamentar = col_character(),
                   idCadastro = col_integer(),
                   sgUF = col_character(),
                   sgPartido = col_character(),
                   tipoDespesa = col_character(),
                   especDespesa = col_character(),
                   fornecedor = col_character(),
                   CNPJCPF = col_character(),
                   tipoDocumento = col_integer(),
                   dataEmissao = col_character(),
                   valorDocumento = col_double(),
                   valorGlosa = col_integer(),
                   valorLíquido = col_double())) %>%
  mutate(dataEmissao = parse_date_time(dataEmissao,"%Y-%m-%d %H:%M:%S"),
         year_month = paste(lubridate::year(dataEmissao),
                            lubridate::month(dataEmissao),sep = "-"),
         tipoDespesa = toupper(tipoDespesa))

state_info <- read_csv(here::here("/data/limiteMensalCEAP.csv"),
                       progress = F,
                       col_types = cols(
                         UF = col_character(),
                         limite_mensal = col_double()))

data %>% 
  full_join(state_info,
            by = c("sgUF" = "UF")) -> data

data %>%
  glimpse()
```

<br>

***

<br>

# Overall spending of the CEAP budget

<br>

## Which parliamentarians spent the most?

```{r}
data %>%
  group_by(sgUF,idCadastro,nomeParlamentar) %>%     # calculate expense for
  summarize(total_expense = sum(valorLíquido)) %>%  # each parliamentarian
  ungroup() %>%                                   
  top_n(n=10, wt=total_expense) %>%  # get the top 10 expenders
  ggplot(aes(total_expense, 
             reorder(nomeParlamentar,
                     total_expense))) +
  geom_segment(aes(x = min(total_expense),
                   y =reorder(nomeParlamentar,
                              total_expense),
                   xend = total_expense,
                   yend = nomeParlamentar),
               color = "grey50", size=0.35) +
  geom_point(aes(color=sgUF), size=3.5) +
  scale_x_continuous(breaks = seq(from = 135E3,
                                  to=1E7,
                                  by = 1E4)) +
  theme(axis.text.x = element_text(angle = 30,
                                   hjust = 1)) +
  guides(color=guide_legend("State")) +
  labs(x="Total Expense (R$)", 
       y="Parliamentarian name")
```

* The parliamentarian _Edio Lopes_ from the state of Roraima is the biggest spender with a total expense of $R\$\:1,\!485,\!000.\,00$ (that's almost **1.5 million reais**).
    + _Edio Lopes_ spent what the second place _Hiran Gonçalves_ (also from Roraima) spent plus some $R\$\:55,\!000.\,00$.
    + _Edio Lopes_ spent what the tenth place _Silas Câmara_ from the state of Amazonas spent plus some $R\$\: 80,\!000.\,00$.
* All 10 parliamentarians spent well over *1 million reais*, furthermore none of the states involved are usually pointed as one of the richest brazilian states. 
    + Among the states that made to the rank Amazonas would be the most proeminent and yet its parliamentarian is right at the bottom of the top 10 rank. 
* Half of the big spenders are from the state of Roraima (top three included).

```{r}
state_info %>%
  ggplot(aes(reorder(UF,limite_mensal),
             limite_mensal)) +          
  geom_point() +
  scale_y_continuous(breaks = seq(5E2,5E5,1.5E3)) +
  labs(y="Montly allowance", x="State")
```

* The state of Roraima (RR) has the biggest montly allowance in the whole country which is approximately $R\$\:45,\!500.\,00$.  It makes sense that their parlamentarians are amongst the biggest spenders in the whole country.

* The federal district (DF), where's the capital, has the smallest allowance which is a little more than $R\$\:30,\!500.\,00$. A parliamentarian who lives there doesn't have to travel to the DF and probably already has a house there, so this is to be expected.

<br>

## Which parliamentarians spent less? 

```{r}
data %>%
  group_by(sgUF,idCadastro,nomeParlamentar) %>%
  summarize(total_expense = sum(valorLíquido)) %>%
  ungroup() %>%
  filter(total_expense >= 0) %>%
  arrange(total_expense) %>%
  slice(1:3)
```

* Let's keep the exact values here for the sake of reference.

```{r}
data %>%
  group_by(sgUF,idCadastro,nomeParlamentar) %>%     # calculate expense for
  summarize(total_expense = sum(valorLíquido)) %>%  # each parliamentarian
  ungroup() %>%
  filter(total_expense >= 0) %>%  # Remove those without actual net amount 
  arrange(total_expense) %>%      # Order by total expense  
  slice(1:10) %>%                 # Get the top 10 frugal
  ggplot(aes(total_expense,
             reorder(nomeParlamentar,
                     total_expense))) +
  geom_segment(aes(x = 0,
                   y = reorder(nomeParlamentar,
                               -total_expense),
                   xend = total_expense,
                   yend = nomeParlamentar),
               color = "grey50", size=0.35) +
  geom_point(aes(color=sgUF), size=3.5) +
  scale_x_continuous(breaks = seq(from = 0,
                                  to=1E5,
                                  by = 20)) +
  guides(color=guide_legend("State")) +
  labs(x="Total Expense (R$)",
       y="Parliamentarian name")
```

Going against what one would expect none of the more frugal parliamentarians are from the Federal District (DF) which has the smallest monthly allowance.

* Our frugal friends live in other states so they had to travel and pay for accommodations. So, how did they pay for the aforementioned expenses? Did it come from their own pockets?   
    + Our most frugal parliamentarian _Camilo Cola_ spent the rather astonishingly small sum of $R\$\:0.\,62$

<br>

### A closer look at the 3 most frugal parliamentarians in Brazil

```{r}
data %>%
  select(sgUF,fornecedor,
         nomeParlamentar,
         sgPartido,tipoDespesa) %>%
  filter(nomeParlamentar %in% 
         c("CAMILO COLA",
           "MARCIO MONTEIRO",
           "MARCELO ALMEIDA"))
```

* The only expense of each of the top 3 frugal parliamentarians was related to telephony. Most likely something they couldn't pay for themselves in reason of bureaucracy. 

<br>

#### Camilo Cola
##### Looking up the most frugal parliamentarians in Brazil we can have an idea of who he is. Originally very poor, **Camilo Cola** is a self made businessman and founder of a whole bussiness empire called Grupo Itapemirim. When **Camilo** first became a parliamentarian he was over 80 years old.

> Camilo Cola seems the type of man that would pay for pretty much all of his expenses as parliamentarian.

<br>

#### Marcelo Almeida
##### Our second place **Marcelo Almeida** was pointed as the richest parliamentarian in Brazil by the portal 'Uol Eleições' in 2014.

> It's likely that our second place '_the richest parliamentarian in Brazil_' paid for most of his expenses. 

<br>

#### Marcio Monteiro
##### Our third place **Marcio Monteiro** quickly left his position as parliamentarian and from then on his office was occupied by his substitute **Elizeu Dionízio**. 

> The third place simply didn't have enough time to spend the money.

<br>

***

<br>

# Looking at spending by state

<br>

## Parliamentarians from which states spent the most abroad? And the less?  

<br>

```{r}
data %>%
  filter(tipoDocumento == 2) %>%  # Keep only expenses abroad 
  group_by(sgUF) %>%  # group by State 
  summarize(international_expense = sum(valorLíquido)) %>% # calc expense by state
  ggplot(aes(reorder(sgUF,international_expense),
             international_expense)) +
  geom_bar(stat = "identity") +
  labs(x="States", y="Expenses abroad (R$)")
```

* Parliamentarians from Maranhão, Paraíba and Pará spent the less abroad.
    + Maranhão spendings are incredibly small, a closer look is due.
* Parliamentarians from São Paulo, Minas Gerais and Pernambuco spent the most abroad
    + São Paulo and Minas Gerais were expected results as both are some of the richest states in Brazil. 

```{r}
data %>%
  filter(tipoDocumento == 2) %>%
  filter(sgUF == "MA") %>%
  select(fornecedor,
         tipoDespesa,
         valorLíquido,
         nomeParlamentar,
         sgUF,
         sgPartido)
```

* The whole international expense made by all the parliamentarians from the state of Maranhão was some meal bought at a convenience store. For the looks of the chain of convenience stores it was most likely fast food.

<br>

## Which parliamentarians violated the CEAP budget set by their state the most?

```{r}
data %>%
  group_by(sgUF,idCadastro,year_month,          # group by parliamentarian
           nomeParlamentar,limite_mensal) %>%   # and vars of interest
  summarise(monthly_expense = sum(valorLíquido)) %>% # calc expense by month/year
  filter(year_month != "NA-NA") %>%  # remove expense without a month/year  
  filter(monthly_expense > limite_mensal) %>%  # keep only violations
  ungroup() -> expense_month_year
#
expense_month_year %>%
  select(nomeParlamentar,
         year_month,
         limite_mensal,
         monthly_expense) %>%
  sample_n(5)
```

* We now have the montly expense of the parliamentarians that violated their respective montly allowance.

```{r}
expense_month_year %>%
  group_by(idCadastro,nomeParlamentar) %>% # group only by parliamentarian 
  arrange(desc(monthly_expense)) %>%   # order by month/year expense
  slice(1) %>%                         # keep biggest expense of each parliamentarian
  ungroup() %>%
  top_n(n=10, wt=monthly_expense) %>%  # get overall top 10 month/year expenses 
  mutate(overbudget = monthly_expense - limite_mensal) %>% # calc actual overbudget
  ggplot(aes(overbudget,
             reorder(nomeParlamentar,
                     overbudget))) +
  geom_segment(aes(x = 1E5, 
                   y =reorder(nomeParlamentar,
                              overbudget),
                   xend = overbudget,
                   yend = nomeParlamentar),
               color = "grey50",
               size=0.35) +
  geom_point(aes(color=sgUF),size=3) +
  labs(x="Overbudget (R$)",
       y="parliamentarians")

```

* At the top of the rank we have Pastor Eurico who managed to spend over R$ 180,000 more than he should in a single month. 
* All of our ranked parliamentarians somehow had to spend way over R$ 100,000 than they should have in the period of a single month.

## At which states the parliamentarians spent the most with airfare ? And the less? 

```{r}
data %>%
  filter(tipoDespesa == "PASSAGENS AÉREAS") %>%
  group_by(sgUF) %>%
  summarize(international_expense = sum(valorLíquido)) %>%
  filter(sgUF != "NA") %>%
  ggplot(aes(reorder(sgUF,international_expense),
             international_expense)) +
  geom_bar(stat = "identity") +
  labs(x="States", y="Flight expense")
```

#### States where parliamentarians spent most with airfare

* We have **São Paulo - SP**, **Amazonas - AM**, **Rio de Janeiro - RJ**, **Minas Gerais - MG** and **Roraima - RR**.
    + **São Paulo - SP**, **Amazonas - AM**, **Rio de Janeiro - RJ** and **Minas Gerais - MG** count among the richest states in the country and Amazonas is very far away from the capital in the **Federal District - DF**.
    + As seen before **Roraima - RR** has the biggest montly allowance in the whole country.

<br>

#### States where parliamentarians spent less with airfare

* We have **Distrito Federal - DF**, **Amapá - AP**, **Rio Grande do Norte - RN**, **Acre - AC**, **Paraíba - PB**.
    + The capital is in **Distrito Federal - DF** so not a lot of reasons to fly around.
    + **Amapá - AP**, **Rio Grande do Norte - RN**, **Acre - AC** and **Paraíba - PB** do not count among the richest or most prominent states of Brazil, so it's reasonable their parliamentarians spent less. 

<br>

***

<br>

# Taking a closer look at Paraíba 

<br>

## In which parties the parliamentarians used CEAP more frequently? In which they used it less frequently?

```{r}
data %>%
  filter(sgUF == "PB") %>%
  na.omit(sgUF,
          sgPartido) %>%
  group_by(sgPartido) %>%
  summarize(frequency =n()) %>%
  ggplot(aes(reorder(sgPartido,frequency),
             frequency)) +
  geom_bar(stat = "identity") +
  labs(x="Parties", y="Absolute frequency")
```

## In which parties the parliamentarians spent the most from CEAP? In which they spent the less?

```{r}
data %>%
  filter(sgUF == "PB") %>%
  na.omit(sgUF,
          sgPartido,
          valorLíquido) %>%
  group_by(sgPartido) %>%
  summarize(total_expense = sum(valorLíquido)) %>%
  ggplot(aes(reorder(sgPartido,total_expense),
             total_expense)) +
  geom_bar(stat = "identity") +
  labs(x="Parties", y="Total expense")
```

<br>

***

<br>


# Looking at expense by political party

## What type of expense is more frequently paid with CEAP by parliamentarians of these parties? 

### PSDB

```{r}
data %>%
  filter(sgPartido %in% c("PSDB")) %>%
  group_by(tipoDespesa) %>%
  summarize(frequency = n()) %>%
  ggplot(aes(reorder(tipoDespesa,frequency),
             frequency)) +
  geom_bar(stat="identity",
           fill="#1E347F") + 
  coord_flip()
```

### PMDB

```{r}
data %>%
  filter(sgPartido %in% c("PMDB")) %>%
  group_by(tipoDespesa) %>%
  summarize(frequency = n()) %>%
  ggplot(aes(reorder(tipoDespesa,frequency),
             frequency)) +
  geom_bar(stat="identity",
           fill="#7F6607") + 
  labs(y= "Absolute Frequency", 
       x="Type of expense") +
  coord_flip()
```

### PT

```{r}
data %>%
  filter(sgPartido %in% c("PT")) %>%
  group_by(tipoDespesa) %>%
  summarize(frequency = n()) %>%
  ggplot(aes(reorder(tipoDespesa,frequency),
             frequency)) +
  geom_bar(stat="identity",
           fill="#7F1707") + 
  labs(y= "Absolute Frequency", 
       x="Type of expense") +
  coord_flip()
```



## What type of expense paid with CEAP by parliamentarians of these parties costs more?

### PSDB

```{r}
data %>%
  filter(sgPartido %in% c("PSDB")) %>%
  group_by(tipoDespesa) %>%
  summarize(expense = sum(valorLíquido)) %>%
  ggplot(aes(reorder(tipoDespesa,expense),
             expense)) +
  geom_bar(stat="identity",
           fill="#1E347F") +
  labs(y= "Total expense", 
       x="Type of expense") +
  coord_flip() 
```

### PMDB

```{r}
data %>%
  filter(sgPartido %in% c("PMDB")) %>%
  group_by(tipoDespesa) %>%
  summarize(expense = sum(valorLíquido)) %>%
  ggplot(aes(reorder(tipoDespesa,expense),
             expense)) +
  geom_bar(stat="identity",
           fill="#7F6607") +
  labs(y= "Total expense", 
       x="Type of expense") +
  coord_flip() 
```

### PT


```{r}
data %>%
  filter(sgPartido %in% c("PT")) %>%
  group_by(tipoDespesa) %>%
  summarize(expense = sum(valorLíquido)) %>%
  ggplot(aes(reorder(tipoDespesa,expense),
             expense)) +
  geom_bar(stat="identity",
           fill="#7F1707") +
  labs(y= "Total expense", 
       x="Type of expense") +
  coord_flip() 
```
