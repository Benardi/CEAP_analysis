---
title: "CEAP Analysis"
author: "José Benardi de Souza Nunes"
output:
  html_notebook:
    toc: yes
    toc_float: yes
---

# Introduction 

> This exploratory data analysis was made based with data provided by the Brazilian government  about the expenses allowed to its parliamentarians (CEAP). More information about (in Portuguese) can be found in its [official site](http://www2.camara.leg.br/transparencia/acesso-a-informacao/copy_of_perguntas-frequentes/cota-para-o-exercicio-da-atividade-parlamentar)


```{r}
library(tidyverse)
library(here)
```

```{r}
data <- read_csv(here::here("data/dadosCEAP.csv"),
                 progress = F,
                 col_types = cols(
                   nomeParlamentar = col_character(),
                   idCadastro = col_integer(),
                   sgUF = col_character(),
                   sgPartido = col_character(),
                   tipoDespesa = col_character(),
                   especDespesa = col_character(),
                   fornecedor = col_character(),
                   CNPJCPF = col_character(),
                   tipoDocumento = col_integer(),
                   dataEmissao = col_character(),
                   valorDocumento = col_double(),
                   valorGlosa = col_integer(),
                   valorLíquido = col_double())) %>%
  mutate(dataEmissao = lubridate::parse_date_time(dataEmissao,
                                                  "%Y-%m-%d %H:%M:%S"),
         year_month = paste(lubridate::year(dataEmissao),
                            lubridate::month(dataEmissao),
                            sep = "-"),
         tipoDespesa = toupper(tipoDespesa))

state_info <- read_csv(here::here("/data/limiteMensalCEAP.csv"),
                 progress = F,
                 col_types = cols(
                   UF = col_character(),
                   limite_mensal = col_double()))

data %>% 
  full_join(state_info,
            by = c("sgUF" = "UF")) -> data

data %>%
  glimpse()
```

<br>

***

<br>

# Overall spending of the CEAP budget

<br>

## Which parliamentarians spent the most?

```{r}
data %>%
  group_by(sgUF,
           idCadastro,
           nomeParlamentar) %>%
  summarize(total_expense = sum(valorLíquido)) %>%
  ungroup() %>%
  top_n(n=10, wt=total_expense) %>%
  ggplot(aes(total_expense, 
             reorder(nomeParlamentar,
                     total_expense))) +
  geom_segment(aes(x = min(total_expense),
                   y =reorder(nomeParlamentar,
                              total_expense),
                   xend = total_expense,
                   yend = nomeParlamentar),
               color = "grey50",
               size=0.35) +
  geom_point(aes(color=sgUF),size=3.5) +
  scale_x_continuous(breaks = seq(from = 135E3,
                                  to=1E7,
                                  by = 1E4)) +
  theme(axis.text.x = element_text(angle = 30,
                                   hjust = 1)) +
  labs(x="Total Expense (R$)", 
       y="Parliamentarian name")
```

## Which parliamentarians spent less? 

```{r}
data %>%
  group_by(sgUF,
           idCadastro,
           nomeParlamentar) %>%
  summarize(total_expense = sum(valorLíquido)) %>%
  ungroup() %>%
  filter(total_expense >= 0) %>%
  arrange(total_expense) %>%
  slice(1:10) %>%
  ggplot(aes(total_expense, 
             reorder(nomeParlamentar,total_expense))) +
  geom_segment(aes(x = 0, y =reorder(nomeParlamentar,-total_expense),
                   xend = total_expense,
                   yend = nomeParlamentar),
               color = "grey50",
               size=0.35) +
  geom_point(aes(color=sgUF),size=3.5) +
  scale_x_continuous(breaks = seq(from = 0,
                                  to=1E5,
                                  by = 20)) +
  labs(x="Total Expense (R$)", 
       y="Parliamentarian name")
```

```{r}
data %>%
  filter(tipoDocumento == 2) %>%
  group_by(sgUF) %>%
  summarise(international_expense = sum(valorLíquido)) %>%
  arrange(international_expense)
```

<br>

***

<br>

# Looking at spending by state

<br>

## Parliamentarians from which states spent the most abroad? And the less?  

<br>

```{r}
data %>%
  filter(tipoDocumento == 2) %>%
  group_by(sgUF) %>%
  summarize(international_expense = sum(valorLíquido)) %>%
  ggplot(aes(reorder(sgUF,international_expense),
             international_expense)) +
  geom_bar(stat = "identity") +
  labs(x="States", y="International expense")
```

## Which parliamentarians violated the CEAP budget set by their state the most?

```{r}
data %>%
  group_by(sgUF,
           idCadastro,
           limite_mensal,
           nomeParlamentar,
           year_month) %>%
  summarise(monthly_expense = sum(valorLíquido)) %>%
  filter(year_month != "NA-NA") %>%
  filter(monthly_expense > limite_mensal) %>%
  ungroup() %>%
  group_by(idCadastro,
           nomeParlamentar) %>%
  arrange(desc(monthly_expense)) %>% 
  slice(1) %>%
  ungroup() %>%
  top_n(n=10, wt=monthly_expense) %>%
  mutate(overbudget = monthly_expense - limite_mensal) %>%
  ggplot(aes(overbudget,
             reorder(nomeParlamentar,
                     overbudget))) +
  geom_segment(aes(x = 1E5, 
                   y =reorder(nomeParlamentar,
                              overbudget),
                   xend = overbudget,
                   yend = nomeParlamentar),
               color = "grey50",
               size=0.35) +
  geom_point(aes(color=sgUF),size=3) +
  labs(x="Overbudget",
       y="Parliamentar")

```

## At which states the parliamentarians spent the most with airfare ? And the less? 

```{r}
data %>%
  filter(tipoDespesa == "PASSAGENS AÉREAS") %>%
  group_by(sgUF) %>%
  summarize(international_expense = sum(valorLíquido)) %>%
  filter(sgUF != "NA") %>%
  ggplot(aes(reorder(sgUF,international_expense),
             international_expense)) +
  geom_bar(stat = "identity") +
  labs(x="States", y="Flight expense")
```


<br>

***

<br>

# Taking a closer look at Paraíba 

<br>

## In which parties the parliamentarians used CEAP more frequently? In which they used it less frequently?

```{r}
data %>%
  filter(sgUF == "PB") %>%
  na.omit(sgUF,
          sgPartido) %>%
  group_by(sgPartido) %>%
  summarize(frequency =n()) %>%
  ggplot(aes(reorder(sgPartido,frequency),
             frequency)) +
  geom_bar(stat = "identity") +
  labs(x="Parties", y="Absolute frequency")
```

## In which parties the parliamentarians spent the most from CEAP? In which they spent the less?

```{r}
data %>%
  filter(sgUF == "PB") %>%
  na.omit(sgUF,
          sgPartido,
          valorLíquido) %>%
  group_by(sgPartido) %>%
  summarize(total_expense = sum(valorLíquido)) %>%
  ggplot(aes(reorder(sgPartido,total_expense),
             total_expense)) +
  geom_bar(stat = "identity") +
  labs(x="Parties", y="Total expense")
```

<br>

***

<br>


# Looking at expense by political party

## What type of expense is more frequently paid with CEAP by parliamentarians of these parties? 

### PSDB

```{r}
data %>%
  filter(sgPartido %in% c("PSDB")) %>%
  group_by(tipoDespesa) %>%
  summarize(frequency = n()) %>%
  ggplot(aes(reorder(tipoDespesa,frequency),
             frequency)) +
  geom_bar(stat="identity",
           fill="#1E347F") + 
  coord_flip()
```

### PMDB

```{r}
data %>%
  filter(sgPartido %in% c("PMDB")) %>%
  group_by(tipoDespesa) %>%
  summarize(frequency = n()) %>%
  ggplot(aes(reorder(tipoDespesa,frequency),
             frequency)) +
  geom_bar(stat="identity",
           fill="#7F6607") + 
  labs(y= "Absolute Frequency", 
       x="Type of expense") +
  coord_flip()
```

### PT

```{r}
data %>%
  filter(sgPartido %in% c("PT")) %>%
  group_by(tipoDespesa) %>%
  summarize(frequency = n()) %>%
  ggplot(aes(reorder(tipoDespesa,frequency),
             frequency)) +
  geom_bar(stat="identity",
           fill="#7F1707") + 
  labs(y= "Absolute Frequency", 
       x="Type of expense") +
  coord_flip()
```



## What type of expense paid with CEAP by parliamentarians of these parties costs more?

### PSDB

```{r}
data %>%
  filter(sgPartido %in% c("PSDB")) %>%
  group_by(tipoDespesa) %>%
  summarize(expense = sum(valorLíquido)) %>%
  ggplot(aes(reorder(tipoDespesa,expense),
             expense)) +
  geom_bar(stat="identity",
           fill="#1E347F") +
  labs(y= "Total expense", 
       x="Type of expense") +
  coord_flip() 
```

### PMDB

```{r}
data %>%
  filter(sgPartido %in% c("PMDB")) %>%
  group_by(tipoDespesa) %>%
  summarize(expense = sum(valorLíquido)) %>%
  ggplot(aes(reorder(tipoDespesa,expense),
             expense)) +
  geom_bar(stat="identity",
           fill="#7F6607") +
  labs(y= "Total expense", 
       x="Type of expense") +
  coord_flip() 
```

### PT


```{r}
data %>%
  filter(sgPartido %in% c("PT")) %>%
  group_by(tipoDespesa) %>%
  summarize(expense = sum(valorLíquido)) %>%
  ggplot(aes(reorder(tipoDespesa,expense),
             expense)) +
  geom_bar(stat="identity",
           fill="#7F1707") +
  labs(y= "Total expense", 
       x="Type of expense") +
  coord_flip() 
```
