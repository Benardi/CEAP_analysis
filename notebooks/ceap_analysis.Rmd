---
title: "C.E.A.P Analysis"
subtitle: "Exploratory data analysis on 'Quota for the exercise of parliamentary activity' provided by the Brazilian government"
author: "José Benardi de Souza Nunes"
date: 30/08/2018
output:
  html_notebook:
    toc: yes
    toc_float: yes
---

<br>

# Introduction 

<br>

> This exploratory data analysis was made based on data provided by the Brazilian government  about the expenses allowed to its parliamentarians or C.E.A.P. (Cota para o Exercício da Atividade Parlamentar / Quota for the Exercise of Parliamentary Activity). More information about it (in Portuguese) can be found in its [official site](http://www2.camara.leg.br/transparencia/acesso-a-informacao/copy_of_perguntas-frequentes/cota-para-o-exercicio-da-atividade-parlamentar)

<br>

```{r}
library(tidyverse)
library(here)
```

```{r}
data <- read_csv(here::here("data/dadosCEAP.csv"),
                 progress = F,
                 col_types = cols(
                   nomeParlamentar = col_character(),
                   idCadastro = col_integer(),
                   sgUF = col_character(),
                   sgPartido = col_character(),
                   tipoDespesa = col_character(),
                   especDespesa = col_character(),
                   fornecedor = col_character(),
                   CNPJCPF = col_character(),
                   tipoDocumento = col_integer(),
                   dataEmissao = col_character(),
                   valorDocumento = col_double(),
                   valorGlosa = col_integer(),
                   valorLíquido = col_double())) %>%
  mutate(dataEmissao = lubridate::parse_date_time(dataEmissao,
                                                  "%Y-%m-%d %H:%M:%S"),
         year_month = paste(lubridate::year(dataEmissao),
                            lubridate::month(dataEmissao),
                            sep = "-"),
         tipoDespesa = toupper(tipoDespesa))

state_info <- read_csv(here::here("/data/limiteMensalCEAP.csv"),
                 progress = F,
                 col_types = cols(
                   UF = col_character(),
                   limite_mensal = col_double()))

data %>% 
  full_join(state_info,
            by = c("sgUF" = "UF")) -> data

data %>%
  glimpse()
```

<br>

***

<br>

# Overall spending of the CEAP budget

<br>

## Which parliamentarians spent the most?

```{r}
data %>%
  group_by(sgUF,
           idCadastro,
           nomeParlamentar) %>%
  summarize(total_expense = sum(valorLíquido)) %>%
  ungroup() %>%
  top_n(n=10, wt=total_expense) %>%
  ggplot(aes(total_expense, 
             reorder(nomeParlamentar,
                     total_expense))) +
  geom_segment(aes(x = min(total_expense),
                   y =reorder(nomeParlamentar,
                              total_expense),
                   xend = total_expense,
                   yend = nomeParlamentar),
               color = "grey50",
               size=0.35) +
  geom_point(aes(color=sgUF),size=3.5) +
  scale_x_continuous(breaks = seq(from = 135E3,
                                  to=1E7,
                                  by = 1E4)) +
  theme(axis.text.x = element_text(angle = 30,
                                   hjust = 1)) +
  guides(color=guide_legend("State")) +
  labs(x="Total Expense (R$)", 
       y="Parliamentarian name")
```

* The parliamentarian _Edio Lopes_ from the state of Roraima is the biggest spender with a total expense of $R\$\:1,\!485,\!000.\,00$ (that's almost **1.5 million reais**).
    + _Edio Lopes_ spent what the second place _Hiran Gonçalves_ (also from Roraima) spent plus some $R\$\:55,\!000.\,00$.
    + _Edio Lopes_ spent what the tenth place _Silas Câmara_ from the state of Amazonas spent plus some $R\$\: 80,\!000.\,00$.
* Half of the big spenders are from the state of Roraima (top three included).

<br>

## Which parliamentarians spent less? 

```{r}
data %>%
  group_by(sgUF,
           idCadastro,
           nomeParlamentar) %>%
  summarize(total_expense = sum(valorLíquido)) %>%
  ungroup() %>%
  filter(total_expense >= 0) %>%
  arrange(total_expense) %>%
  slice(1:10)
```

* Let's keep the exact values here for the sake of reference.

```{r}
data %>%
  group_by(sgUF,
           idCadastro,
           nomeParlamentar) %>%
  summarize(total_expense = sum(valorLíquido)) %>%
  ungroup() %>%
  filter(total_expense >= 0) %>%
  arrange(total_expense) %>%
  slice(1:10) %>%
  ggplot(aes(total_expense, 
             reorder(nomeParlamentar,total_expense))) +
  geom_segment(aes(x = 0, y =reorder(nomeParlamentar,-total_expense),
                   xend = total_expense,
                   yend = nomeParlamentar),
               color = "grey50",
               size=0.35) +
  geom_point(aes(color=sgUF),size=3.5) +
  scale_x_continuous(breaks = seq(from = 0,
                                  to=1E5,
                                  by = 20)) +
  labs(x="Total Expense (R$)", 
       y="Parliamentarian name")
```

* The parliamentarian _Camilo Cola_ spent the rather astonishing small sum of $R\$\:0.\,62$
* Going against what one would expect none of the more frugal parliamentarians are from the Federal District (DF). A parliamentarian who lived there wouldn't have to travel to the DF and would probably already have a house there.
    +  How did our frugal friends pay for the aforementioned expenses? Did it come from their own pockets?   

```{r}
data %>%
  select(nomeParlamentar,
         sgUF,
         sgPartido,
         tipoDespesa,
         fornecedor) %>%
  filter(nomeParlamentar %in% 
         c("CAMILO COLA",
           "MARCIO MONTEIRO",
           "MARCELO ALMEIDA"))
```

* The top 3 frugal parliamentarians only expense was related to telephony. Most likely a mere formality. 

<br>

> Looking up the most frugal of our parliamentarians _Camilo Cola_ we can have an idea of who he is. _Camilo Cola_ is a self made businessman and founder of a whole bussiness empire called _Grupo Itapemirim_. Originally very poor, when he was 18 years old _Camilo_ left to fight World War II. When _Camilo_ first became a parliamentarian he was over 80 years old. _Camilo Cola_ seems the type of man that would pay for pretty much all of his expenses as parliamentarian.

<br>

***

<br>

# Looking at spending by state

<br>

## Parliamentarians from which states spent the most abroad? And the less?  

<br>

```{r}
data %>%
  filter(tipoDocumento == 2) %>%
  group_by(sgUF) %>%
  summarise(international_expense = sum(valorLíquido)) %>%
  arrange(international_expense)
```

```{r}
data %>%
  filter(tipoDocumento == 2) %>%
  group_by(sgUF) %>%
  summarize(international_expense = sum(valorLíquido)) %>%
  ggplot(aes(reorder(sgUF,international_expense),
             international_expense)) +
  geom_bar(stat = "identity") +
  labs(x="States", y="International expense")
```

## Which parliamentarians violated the CEAP budget set by their state the most?

```{r}
data %>%
  group_by(sgUF,
           idCadastro,
           limite_mensal,
           nomeParlamentar,
           year_month) %>%
  summarise(monthly_expense = sum(valorLíquido)) %>%
  filter(year_month != "NA-NA") %>%
  filter(monthly_expense > limite_mensal) %>%
  ungroup() %>%
  group_by(idCadastro,
           nomeParlamentar) %>%
  arrange(desc(monthly_expense)) %>% 
  slice(1) %>%
  ungroup() %>%
  top_n(n=10, wt=monthly_expense) %>%
  mutate(overbudget = monthly_expense - limite_mensal) %>%
  ggplot(aes(overbudget,
             reorder(nomeParlamentar,
                     overbudget))) +
  geom_segment(aes(x = 1E5, 
                   y =reorder(nomeParlamentar,
                              overbudget),
                   xend = overbudget,
                   yend = nomeParlamentar),
               color = "grey50",
               size=0.35) +
  geom_point(aes(color=sgUF),size=3) +
  labs(x="Overbudget",
       y="Parliamentar")

```

## At which states the parliamentarians spent the most with airfare ? And the less? 

```{r}
data %>%
  filter(tipoDespesa == "PASSAGENS AÉREAS") %>%
  group_by(sgUF) %>%
  summarize(international_expense = sum(valorLíquido)) %>%
  filter(sgUF != "NA") %>%
  ggplot(aes(reorder(sgUF,international_expense),
             international_expense)) +
  geom_bar(stat = "identity") +
  labs(x="States", y="Flight expense")
```


<br>

***

<br>

# Taking a closer look at Paraíba 

<br>

## In which parties the parliamentarians used CEAP more frequently? In which they used it less frequently?

```{r}
data %>%
  filter(sgUF == "PB") %>%
  na.omit(sgUF,
          sgPartido) %>%
  group_by(sgPartido) %>%
  summarize(frequency =n()) %>%
  ggplot(aes(reorder(sgPartido,frequency),
             frequency)) +
  geom_bar(stat = "identity") +
  labs(x="Parties", y="Absolute frequency")
```

## In which parties the parliamentarians spent the most from CEAP? In which they spent the less?

```{r}
data %>%
  filter(sgUF == "PB") %>%
  na.omit(sgUF,
          sgPartido,
          valorLíquido) %>%
  group_by(sgPartido) %>%
  summarize(total_expense = sum(valorLíquido)) %>%
  ggplot(aes(reorder(sgPartido,total_expense),
             total_expense)) +
  geom_bar(stat = "identity") +
  labs(x="Parties", y="Total expense")
```

<br>

***

<br>


# Looking at expense by political party

## What type of expense is more frequently paid with CEAP by parliamentarians of these parties? 

### PSDB

```{r}
data %>%
  filter(sgPartido %in% c("PSDB")) %>%
  group_by(tipoDespesa) %>%
  summarize(frequency = n()) %>%
  ggplot(aes(reorder(tipoDespesa,frequency),
             frequency)) +
  geom_bar(stat="identity",
           fill="#1E347F") + 
  coord_flip()
```

### PMDB

```{r}
data %>%
  filter(sgPartido %in% c("PMDB")) %>%
  group_by(tipoDespesa) %>%
  summarize(frequency = n()) %>%
  ggplot(aes(reorder(tipoDespesa,frequency),
             frequency)) +
  geom_bar(stat="identity",
           fill="#7F6607") + 
  labs(y= "Absolute Frequency", 
       x="Type of expense") +
  coord_flip()
```

### PT

```{r}
data %>%
  filter(sgPartido %in% c("PT")) %>%
  group_by(tipoDespesa) %>%
  summarize(frequency = n()) %>%
  ggplot(aes(reorder(tipoDespesa,frequency),
             frequency)) +
  geom_bar(stat="identity",
           fill="#7F1707") + 
  labs(y= "Absolute Frequency", 
       x="Type of expense") +
  coord_flip()
```



## What type of expense paid with CEAP by parliamentarians of these parties costs more?

### PSDB

```{r}
data %>%
  filter(sgPartido %in% c("PSDB")) %>%
  group_by(tipoDespesa) %>%
  summarize(expense = sum(valorLíquido)) %>%
  ggplot(aes(reorder(tipoDespesa,expense),
             expense)) +
  geom_bar(stat="identity",
           fill="#1E347F") +
  labs(y= "Total expense", 
       x="Type of expense") +
  coord_flip() 
```

### PMDB

```{r}
data %>%
  filter(sgPartido %in% c("PMDB")) %>%
  group_by(tipoDespesa) %>%
  summarize(expense = sum(valorLíquido)) %>%
  ggplot(aes(reorder(tipoDespesa,expense),
             expense)) +
  geom_bar(stat="identity",
           fill="#7F6607") +
  labs(y= "Total expense", 
       x="Type of expense") +
  coord_flip() 
```

### PT


```{r}
data %>%
  filter(sgPartido %in% c("PT")) %>%
  group_by(tipoDespesa) %>%
  summarize(expense = sum(valorLíquido)) %>%
  ggplot(aes(reorder(tipoDespesa,expense),
             expense)) +
  geom_bar(stat="identity",
           fill="#7F1707") +
  labs(y= "Total expense", 
       x="Type of expense") +
  coord_flip() 
```
